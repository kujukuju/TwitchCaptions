
<html>
    <head>
        <style>
            html, body {
                margin: 0;
                padding: 0;

                margin-left: 16px;

                color: #ffffff;
                font-size: 24px;
            }

            div div {
                height: 36px;
                line-height: 36px;

                opacity: 0;
                filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0));

                transition: height 400ms ease, opacity 400ms ease, filter 400ms ease;
            }

            div div.expanded {
                height: 36px;
                opacity: 1;
                filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.75));
            }
        </style>
        <script>
            let pending = false;
            setInterval(async () => {
                if (pending) {
                    return;
                }
                pending = true;
                
                try {
                    const request = await fetch("http://localhost:9000/captions");
                    const json = await request.json();

                    const indices = [];
                    const captured = [];
                    const translated = [];

                    for (let i = 0; i < json.length; i += 3) {
                        indices.push(json[i])
                        captured.push(json[i + 1]);
                        translated.push(json[i + 2]);
                    }

                    const dividerElement = document.getElementById('divider');

                    const container = document.getElementById('container');
                    let child = container.firstElementChild;
                    while (child) {
                        const nextChild = child.nextElementSibling;

                        const index = Number.parseInt(child.dataset.index);
                        const found = indices.findIndex(i => i === index) >= 0 || child == dividerElement;
                        if (!found) {
                            container.removeChild(child);
                        }

                        child = nextChild;
                    }

                    for (let i = 0; i < captured.length; i++) {
                        let found = false;
                        
                        let child = container.firstElementChild;
                        let capturedChild = null;
                        let translatedChild = null;
                        while (child) {
                            if (Number.parseInt(child.dataset.index) === indices[i] && !capturedChild) {
                                capturedChild = child;
                            } else if (Number.parseInt(child.dataset.index) === indices[i] && !translatedChild) {
                                translatedChild = child;
                            }

                            child = child.nextElementSibling;
                        }

                        if (!capturedChild && !translatedChild) {
                            const capturedElement = document.createElement('div');
                            capturedElement.innerText = captured[i];
                            capturedElement.dataset.index = indices[i];
                            container.insertBefore(capturedElement, dividerElement);

                            const translatedElement = document.createElement('div');
                            translatedElement.innerText = translated[i];
                            translatedElement.dataset.index = indices[i];
                            container.appendChild(translatedElement);

                            setTimeout(() => {
                                capturedElement.classList.add('expanded');
                                translatedElement.classList.add('expanded');
                            }, 50);
                        } else {
                            if (capturedChild.innerText !== captured[i]) {
                                capturedChild.innerText = captured[i];
                            }
                            if (translatedChild.innerText !== translated[i]) {
                                translatedChild.innerText = translated[i];
                            }
                        }
                    }
                } catch (e) {}

                pending = false;
            }, 100);
        </script>
    </head>
    <body>
        <div id="container">
            <br id="divider" />
        </div>
    </body>
</html>
